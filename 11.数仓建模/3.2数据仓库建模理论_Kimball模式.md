# `Kimball`模式（维度建模）

## 概念

- Kimball 模式从流程上看是是自底向上的，即从数据集市到数据仓库再到数据源(先有数据集市再有数据仓库)的一种敏捷开发方法。对于Kimball模式，数据源往往是给定的若干个数据库表，数据较为稳定但是数据之间的关联关系比较复杂，需要从这些OLTP中产生的事务型数据结构抽取出分析型数据结构，再放入数据集市中方便下一步的BI与决策支持。

## 流程

- 通常，Kimball都是以最终任务为导向。首先，在得到数据后需要先做数据的探索，尝试将数据按照目标先拆分出不同的表需求。
- 其次，在明确数据依赖后将各个任务再通过ETL由Stage层转化到DM层。这里DM层数据则由若干个事实表和维度表组成。
- 接着，在完成DM层的事实表维度表拆分后，数据集市一方面可以直接向BI环节输出数据了，另一方面可以先DW层输出数据，方便后续的多维分析。

## 特点

- Kimball支持数据仓库总线结构，提倡维度建模，以星型模型或是雪花模型等方式构建维度数据仓库。架构体系中，数据集市于维度数据仓库是紧密结合的，数据集市是数据仓库中一个逻辑上的主题域。
- Kimball往往意味着快速交付、敏捷迭代，不会对数据仓库架构做过多复杂的设计，在变幻莫测的互联网行业，这种架构方式逐渐成为一种主流范式。

##  Inmon VS Kimball建模方式对比

### 架构设计

- Inmon架构的思想在于自上而下的构建数据模型。以数据源头开始，数据以瀑布流式的向下流动，更加注重数据清洗。其核心思想在于数仓分层。（换言之就是，尽量将某一主题域的所有数据都考虑到数据建模中。这样设计的数据模型的覆盖面会更广，但是数据模型的设计会困难）
- Kimball架构的思想在于自下而上的构建数据模型。以具体业务诉求为出发点，设计数据模型，其核心思想在于维度建模。（即根据业务需求找到关注的数据指标，基于关注的数据指标设计数据模型，这样设计的数据模型会更加的独立，但可能会导致数据模型过多发展）

- 目前企业的数据仓库设计一般都是综合了两者的实现，整体上采用分层架构，具体的模型设计上采用维度建模。

## 维度数据模型

### 建模过程

- 维度模型设计期间主要涉及4个主要的过程:
  1. 选择业务过程
  2. 声明粒度
  3. 确认维度
  4. 确认事实

#### 需求收集

- 收集业务需求，在开始维度建模工作之前，需要理解业务需求，以及作为底层源数据的实际情况。通过与业务方沟通交流、查看现有报表等来发现需求，用于理解他们的基于关键性能指标、决策制定过程、支持分析需求的目标。

#### 业务过程

- 选择业务过程，业务过程是组织完成的操作型活动。理清业务过程，就是需要建立或获取性能度量，并转换为事实表中的事实。多数事实表关注某一业务过程的结果。过程的选择非常重要的，因为过程定义了特定的设计目标以及对粒度、维度、事实的定义。

#### 声明粒度

- 声明粒度，声明粒度是维度设计的重要步骤。粒度用于确定某一事实表中的行表示什么。在选择维度或事实前必须声明粒度，因为每个候选维度或事实必须与定义的粒度保持一致。在从给定的业务过程获取数据时，原子粒度是最低级别的粒度。强烈建议从关注原子级别粒度数据开始设计，因为原子粒度数据能够承受无法预期的用户查询。

#### 确认维度

- 确认维度（描述环境），维度提供围绕某一业务过程事件所涉及的“谁、什么、何处、何时、为什么、如何”等背景。维度表包含分析应用所需要的用于过滤及分类事实的描述性属性。

#### 确认事实

- 确认事实（用于度量），涉及来自业务过程事件的度量，基本上都是以数据值表示。一个事实表行与按照事实表粒度描述的度量事件之间存在一对一关系，因此事实表对应一个物理可观察的事件。在事实表内，所有事实只允许与声明的粒度保持一致。

### 建模特点

#### 易理解

- 相对于规范化的关系模型，维度模型容易理解且更直观。在维度模型中，信息按业务种类或维度进行分组，这会提高信息的可读性，也方便了对于数据含义的解释。
- 简化的模型也让系统以更为高效的方式访问数据库。关系模型中，数据被分布到多个离散的实体中，对于一个简单的业务流程，可能需要很多表联合在一起才能表示。

#### 高性能

- 维度模型更倾向于非规范化，因为这样可以优化查询的性能。
- 介绍关系模型时多次提到，规范化的实质是减少数据冗余，以优化事务处理或数据更新的性能。

#### 可扩展

- 维度模型是可扩展的。由于维度模型允许数据冗余，因此当向一个维度表或事实表中添加字段时，不会像关系模型那样产生巨大的影响，带来的结果就是更容易容纳不可预料的新增数据。
- 这种新增可以是单纯地向表中增加新的数据行而不改变表结构，也可以是在现有表上增加新的属性。
- 基于数据仓库的查询和应用不需要过多改变就能适应表结构的变化。老的查询和应用会维续工作而不会产生错误的结果。

## 维度模型

### 维度规范化

- 与关系模型类似，维度也可以进行规范化。对维度的规范化(又叫雪花化)，可以去除冗余属性，是对非规范化维度做的规范化处理，在下面介绍雪花模型时，会看到维度规范化的例子。

- 一个非规范化维度对应一个维度表，规范化后，一个维度会对应多个维度表，维度被严格地以子维度的形式连接在一起。

- 实际上，在很多情况下，维度规范化后的结构等同于一个低范式级别的关系型结构。

- 设计维度数据模型时，会因为如下原因而不对维度做规范化处理:

  1. 规范化会增加表的数量，使结构更复杂。

  2. 不可避免的多表连接，使查询更复杂。

  3. 查询性能原因。分析查询需要聚合计算或检索很多维度值，此时第三范式的数据会遭遇性能问题。如果需要的仅仅是操作型报表，可以使用第三范式，因为作型系统的用户需要看到更细节的数据。

### 星型模型

#### 什么是星型模型

- 星型模式由事实表和维度表组成，一个星型模式中可以有一个或多个事实表，每个事实表引用任意数量的维表。

#### 维表

- 维度表的记录数通常比事实表少，但每条记录包含有大量用于描述事实数据的属性字段。维度表可以定义各种各样的特性，以下是几种最常用的维度表。
  1. 时间维度表。描述星型模式中记录的事件所发生的时间，具有所需的最低级别的时间粒度。数据仓库是随时间变化的数据集合，需要记录数据的历史，因此每个数据仓库都需要一个时间维度表。
  2. 地理维度表。描述位置信息的数据，如国家、省份、城市、区县、邮编等。
  3. 产品维度表。描述产品及其属性。
  4. 人员维度表。描述人员相关的信息，如销售人员、市场人员、开发人员等。。(5)范围维度表。描述分段数据的信息，如高级、中级、低级等。

#### 优点

- 星型模式是非规范化的，在星型模式的设计开发过程中，不受应用于事务型关系数据库的范式规则的约束。星型模式的优点如下:
  1. 简化查询。查询数据时，星型模式的连接逻辑比较简单，而从高度规范化的事实表查询数据时，往往需要更多的表连接。
  2. 简化业务报表逻辑。与高度规范化的模式相比，由于查询更简单，因此星型模式简化了普通的业务报表(如每月报表)逻辑。
  3. 获得查询性能。星型模式可以提升只读报表类应用的性能。
  4. 快速聚合。基于星型模式的简单查询能够提高聚合操作的性能。
  5. 便于向立方体提供数据。

#### 缺点

- 星型模式的主要缺点是不能保证数据完整性。一次性地插入或更新操作可能会造成数据异常，而这种情况在规范化模型中是可以避免的。
- 星型模式的另一个缺点是对于分析需求来说不够灵活。它更偏重于为特定目的建造数据视图，因此实际上很难进行全面的数据分析。

### 雪花模型

#### 什么是雪花模型

- 当所有的维度表完成规范化后，就形成了以事实表为中心的雪花型结构，即雪花模式。

#### 优点

- 雪花模式是和星型模式类似的逻辑模型。实际上，星型模式是雪花模式的一个特例(维度没有多个层级)。某些条件下，雪花模式更具优势:
  1. 一些OLAP多维数据库建模工具专为雪花模型进行了优化。
  2. 规范化的维度属性节省存储空间。

#### 缺点

- 雪花模型的主要缺点是维度属性规范化增加了查询的连接操作和复杂度。相对于平面化的单表维度，多表连接的查询性能会有所下降。

### 星座模型

#### 什么是星座模型

- 维表是共享状态的，可以被多个事实表关联使用，这种模式可以看做星型模式的汇集，因而称作星系模式或者事实星座模式。

### 维度表设计

#### 基本概念

- 在维度建模中，把度量称为事实，将环境称为维度。
- 维度属性指的就是维度的列。

#### 设计方法

- 维度的设计过程，就是维度属性的确定过程。

- 下面我们用商品维度表的设计为例对维度设计的方法进行详细说明。

  1. 选择维度或者新建维度：在建设维度表中，要保证其在数仓中的唯一性，也就是说只允许有一个商品维表。

  2. 确定维度主来源表：在此处一般指的就是ODS层（与业务系统表结构一样）的商品表，如s_items_info，此表就是维度的主来源表。

  3. 确定相关维表：数据仓库的设计遵循数据的高度整合原则。在确定主来源表后，还需要根据实际需求，扩展商品的相关信息如：类目、所属卖家、所属店铺等。

  4. 确定维度属性：在维度主来源表+相关维表的基础字段上，创建或补充维度属性：
     - 尽可能地生成新的维度属性；
     - 尽可能给出一些包含文字描述的属性，这些属性不应该只有编码，更应该是真正的文字。如一级类目ID，一级类目名称。
     - 某些特殊的度量（数字）有可能也能作为维度属性。如商品单价，既在观察商品价格段时可以作为维度，也可以在求平均商品价格时作为事实。（区分数值型字段是维度还是度量的方法之一，就是看字段内容枚举值的多寡，多很可能是度量；少很可能是维度，但不绝对）
     - 尽量沉淀出常用、公用的字段。如商品状态，需要通过上架时间判断。

#### 维度的层次结构

- 维度是有层次的，也是反范式的。
  - 类目层次：一级类目 》二级类目 》三级类目
  - 时间层次：年 》月 》季度 》周 》天
    - 数据钻取分为上钻（维度减少）和下钻（维度增多）。

#### 一致性维度和交叉检查

- **交叉探查**：将不同数据域（不同业务模块的数据）的事实数据，根据同一个维度做合并的情况就叫交叉探查。

- 要想交叉探查数据无误，就一定要保证：一致性维度。
  - **一致性维度**：Kimball的数据仓库总线架构提供了种分解企业级数据仓库规划任务的合理方法，通过构建企业范围内一致性维度和事实来构建总线架构。意思是**维度建模要求必须有一致性维度**。
  - 如何才能保证有一致性维度呢？有三种方法
    - 共享维度。每个维度全局都唯一（下面的复杂就只要做到这一点就好）
    - 一致性上钻。其中一个维度的维度属性是另一个维度的维度属性的子集，且两个维度的公共维度属性结构和内容相同。比如商品维度和类目维度，其中类目维度的维度属性是商品维度的维度属性的子集，且有相同的维度属性和维度属性值。这样基于类目维度进行不同业务过程的交叉探查也不会存在任何问题。
    - 交叉属性。两个维度具有部分相同的维度属性。比如在商品维度中具有类目属性，在卖家维度中具有主营类目属性，两个维度具有相同的类目属性，则可以在相同的类目属性上进行不同业务过程的交叉探查。

#### 高级主题

##### 什么维度需要整合

- 数据仓库的四大特性里面包含集成。维度的集成的过程可以概括为：将维度相关的维度属性做到统一。
  - 来源系统多的情况下，表名、字段名要统一。
  - 公共代码和编码值统一，如A系统男1，女0，B系统男M，女F。
  - 业务含义相同的表统一：
    1. l 采用主从表方式，如商品维度可以拆成（商品主信息维表 + 商品扩展信息维表）；
    2. 统一到一张表，如果表字段重合度比较低，会出现大量空值情况；
    3. 不合并，如果源表表结构实在差异太大，可以不合并。

##### 什么维表需要拆分

- 当一张维度表中包含多个类别、加工逻辑十分困难、有部分维度属性可以单独处理或者不常用时，考虑将维度拆分。无论是维表是分还是合，都需要从以下角度权衡：**当业务变化时，模型是否容易扩展；是否易用；查询效能问题**。
- 通常来说，拆分方法有以下几种：
  1. 水平拆分——数据层面
  2. 垂直拆分——维度属性层面

#### 处理缓慢变化维度属性

- 数据仓库中另一重要的特点是——反映历史变化。缓慢变化维度，这里的缓慢是跟（快速变化）事实表相对的。
- 业务系统(CRM、OA等)往往并不会保留历史数据。但在分析角度，我们是一定要保留这些改变的痕迹。这种随着时间可能会缓慢变化的维度，就是 缓慢变化维、也就是 SCD（Slowly Changing Dimensions）。

##### 原样保留或者重写

- 原样保留或者重写，这种方式理论上都是取最新的值作为维度的最终的取值，每个维度保留一条数据。
- **保留原样**这种处理方式是最简单的，直接将原系统的维度同步过来使用就可以，不用做过多的处理。
- **重写**就是指，与业务数据保持一致，直接update为最新的数据。这种方法主要应用于以下两种情况：
  1. 数据必须正确——例如用户的身份证号，如需要更新则说明之前录入错误。
  2. 无需考虑历史变化的维度——例如用户的头像url，这种数据往往并没有分析的价值。因此不做保留。

##### 增加新行

- 插人新的维度行，每当维度发生变化的时候，插入新增的一行。
- 采用此种方式，保留历史数据，维度值变化前的事实和过去的维度值关联，维度值变化后的事实和当前的维度值关联。
  - 再回顾2个概念：自然键即指有业务意义的唯一ID，例如用户ID、身份证号等。代理键则可以简单理解为该表的自增ID值。
- 在这种场景下，具体的ETL过程如下：
  1. 自然键第一次出现时，新增一行数据，created为业务系统的创建时间，updated为9999-12-31（数仓的规范不允许数据存在NULL值的情况，因此用9999-12-31代替）。
  2. 当维度发生变化时，将自然键当前记录的updated由9999-12-31刷为最新时间，新增一行记录，记录最新的数据，created为最新时间，updated为 9999-12-31。

##### 增加新属性

- 当需要分析所有伴随着新值或旧值的变化前后记录的事实时，上述两种方法都不能解决问题。这时我们可以添加维度列，采用这种方式，主要是为了将变化前后记录的事实归为变化前的维度或者归为变化后的维度。

##### 快照存储

- 快照存储,这种方式就是每一个周期定时保存一份数据，与第二点有点像，不过这里会产生很多冗余的数据，当维度里大部分行在周期内，变动频繁的时候，可以采用。

##### 历史拉链存储

- 历史拉链存储是基于处理缓慢变化维的第2种方法来加工的，也就是：新建维度行。但不同的是，拉链存储还特地用了两个时间键（生效时间和失效时间）来替代原有的代理键。
- 本质其实就是为了节省存储，其次才是为了反映历史变化。

## 事实表

- 事实表记录了特定事件的数字化的考量，一般由数字值和指向维度表的外键组成。

- 通常会把事实表的粒度级别设计得比较低，使得事实表可以记录很原始的操作型事件，但这样做的负面影响是累加大量记录可能会更耗时。事实表有以下三种类型:

  1. 事务事实表。记录特定事件的事实，如销售。

  2. 快照事实表。记录给定时间点的事实，如月底账户余额。

  3. 累积事实表。记录给定时间点的聚合事实，如当月的总的销售金额。一般需要给事实表设计一个代理键作为每行记录的唯一标识。

### 事实表设计

#### 事实的类型（可加、半可加、不可加）

1. 可加事实：可加事实指的是该度量可以按照和事实表关联的任一维度进行汇总。比如商品的单价，可以按照品类维度进行汇总，按照店铺维度进行汇总等等。

2. 半可加事实：指的就是该度量在某些维度下不可进行汇总，或者说汇总起来没有意义，比如说价差额，价差额在时间维度下的汇总就没有意义。

   记录静态数据（库存数据，金融账户余额）的所有度量针对于日期属性以及其它可能维度天然具有非可加性，但是例如库存数据针对产品种类或者商店汇总，是可加的，所以这种数据就是半可加事实。

3. 不可加事实：指的是该度量在所有与该事实表关联的维度下都不可进行汇总，比如说比率型数据，对于这种数据，如果确实是有汇总的必要，可以将其分子分母分别存储，然后在最后汇总之后再进行除法操作，从而得到“汇总”后的比率型数据。

### 事务事实表

- 事务事实表记录的事务层面的事实，保存的是最原子的数据，也称“原子事实表”。
- **为什么事务事实表具有稀疏性质**？
  - 事实表一般围绕着度量来建立，当度量产生的时候，事实记录就生成了。度量可以是销售数量、交易流水值、月末节余等数值。
  - 如果同时生成多个度量值的话，我们可以在一个事实表中建立多个事实。
  - 当我们的事实表中的事实比较多时，有可能多个事实不同时发生，如果同时生成的几率很小，我们称之为稀疏事实表（Sparse Facts）。

### 周期快照事实表

- 周期快照事实表以具有规律性的、可预见的时间间隔来记录事实，时间间隔如每天、每月、每年等等。

### 累计快照事实表

- 累积快照事实表记录的不确定的周期的数据。累积快照事实表代表的是完全覆盖一个事务或产品的生命周期的时间跨度，它通常具有多个日期字段，用来记录整个生命周期中的关键时间点。

### 三种事实表的区别

- 事务事实表中一条交易记录会每天有一条数据来记录整个交易过程；而累积快照事实表只会有一条记录，数据会一直更新直到过程结束。
- 累积快照事实表代表的是完全覆盖一个事务或产品的生命周期的时间跨度，它通常具有多个日期字段，用来记录整个生命周期中的关键时间点。另外，它还会有一个用于指示最后更新日期的附加日期字段。由于事实表中许多日期在首次加载时是不知道的，所以必须使用代理关键字来处理未定义的日期，而且这类事实表在数据加载完后，是可以对它进行更新的，来补充随后知道的日期信息。
- 周期快照事实表记录的是重复的可预测到的时间间隔的事实，例如账户月结余事实表，用来记录每个月末的账户结余信息。一般周期快照的数据会按报表需要的周期进行记录，比较适合周期长一些的情况。
- ![三种事实表区别](\图片\三种事实表区别.png)

## 总线架构

- 在Kimball的维度建模的数据仓库中，关于多维体系结构（MD）有三个关键性概念：总线架构（Bus Architecture），一致性维度（Conformed Dimension）和一致性事实（Conformed Fact）。
- 多维体系结构主要包括后台（Back Room）和前台（Front Room）两部分。后台也称为数据准备区（Staging Area），是MD架构的最为核心的部件。
- 在后台，是一致性维度的产生、保存和分发的场所。同时，代理键也在后台产生。
- 前台是MD架构对外的接口，包括两种主要的数据集市，一种是原子数据集市，另一种是聚集数据集市。
- 原子数据集市保存着最低粒度的细节数据，数据以星型结构来进行数据存储。
- 聚集数据集市的粒度通常比原子数据集市要高，和原子数据集市一样，聚集数据集市也是以星型结构来进行数据存储。
- 前台还包括像查询管理、活动监控等为了提供数据仓库的性能和质量的服务。

### 一致性维度

- 在多维体系结构中，没有物理上的数据仓库，由物理上的数据集市组合成逻辑上的数据仓库。
- 而且数据集市的建立是可以逐步完成的，最终组合在一起，成为一个数据仓库。
- 如果分步建立数据集市的过程出现了问题，数据集市就会变成孤立的集市，不能组合成数据仓库，而一致性维度的提出正式为了解决这个问题。 
- 一致性维度的内容和普通维度并没有本质上区别，都是经过数据清洗和整合后的结果。
- 一致性维度建立的地点是多维体系结构的后台（Back Room），即数据准备区。
- 在多维体系结构的数据仓库项目组内需要有专门的维度设计师，他的职责就是建立维度和维护维度的一致性。
- 在后台建立好的维度同步复制到各个数据集市。这样所有数据集市的这部分维度都是完全相同的。
- 建立新的数据集市时，需要在后台进行一致性维度处理，根据情况来决定是否新增和修改一致性维度，然后同步复制到各个数据集市。这是不同数据集市维度保持一致的要点。
- 在同一个集市内，一致性维度的意思是两个维度如果有关系，要么就是完全一样的，要么就是一个维度在数学意义上是另一个维度的子集。
- 例如，如果建立月维度话，月维度的各种描述必须与日期维度中的完全一致，最常用的做法就是在日期维度上建立视图生成月维度。
- 这样月维度就可以是日期维度的子集，在后续钻取等操作时可以保持一致。如果维度表中的数据量较大，出于效率的考虑，应该建立物化视图或者实际的物理表。
- 这样，维度保持一致后，事实就可以保存在各个数据集市中。虽然在物理上是独立的，但在逻辑上由一致性维度使所有的数据集市是联系在一起，随时可以进行交叉探察等操作，也就组成了数据仓库。

### 一致性事实

- 在建立多个数据集市时，完成一致性维度的工作就已经完成了一致性的80%－90%的工作量。
- 余下的工作就是建立一致性事实。一致性事实和一致性维度有些不同，一致性维度是由专人维护在后台（Back Room），发生修改时同步复制到每个数据集市，而事实表一般不会在多个数据集市间复制。
- 需要查询多个数据集市中的事实时，一般通过交叉探查（drill across）来实现。 
- 为了能在多个数据集市间进行交叉探查，一致性事实主要需要保证两点：第一个是KPI的定义及计算方法要一致，第二个是事实的单位要一致性。如果业务要求或事实上就不能保持一致的话，建议不同单位的事实分开建立字段保存。
- 这样，一致性维度将多个数据集市结合在一起，一致性事实保证不同数据集市间的事实数据可以交叉探查，一个分布式的数据仓库就建成了。

