# OneData

## 什么是onedata

- OneData即是阿里巴巴内部进行数据整合及管理的方法体系和工具。
- 阿里巴巴的大数据工程师在这一体系下，构建统一、规范、可共享的全域数据体系，避免数据的冗余和重复建设，规避数据烟囱和不一致性，充分发挥阿里巴巴在大数据海量、多样性方面的独特优势。
- 借助这一统一化数据整合及管理的方法体系，我们构建了阿里巴巴的数据公共层，并可以帮助相似的大数据项目快速落地实现。

## 指导思想

- 阿里巴巴集团数据公共层设计理念遵循维度建模思想，可参考Star Schema-The Complete Reference 和The Data Warehouse Toolkit-The Definitive Guide to Dimensional Modeling。
- 数据模型的维度设计主要以维度建模理论为基础，基于维度数据模型总线架构，构建一致性的维度和事实。其核心的实施指导方针如下：
  - 首先，要进行充分的业务调研和需求分析。
  - 其次，进行数据总体架构设计，主要是根据数据域对数据进行划分；按照维度建模理论，构建总线矩阵，抽象出业务过程和维度。
  - 再次，对报表需求进行抽象整理出相关指标体系，使用One Data工具完成指标规范定义和模型设计。
  - 最后，是代码研发和运维。
  - 其实施流程主要分为：数据调研、架构设计、规范定义和模型设计。

## 调研

- **业务调研**：需要确认要规划进数仓的业务领域，以及各业务领域包含的功能模块
- **需求调研**：了解需求方关系哪些指标？需要哪些维度、度量？数据是否沉淀到汇总层等。

## 架构设计

### 数据域的划分

- 数据域是指面向业务分析，将业务过程或者维度进行抽象的集合，一般数据域和应用系统(功能模块)有联系，可以考虑将同一个功能模块系统的业务过程划分到一个数据域。

### 构建总线矩阵

- 在进行充分的业务调研和需求调研后，就要构建总线矩阵了，需要做两件事情：
  1. 明确每个数据域下有哪些业务过程。
  2. 业务过程与哪些维度相关，并通过总线矩阵定义每个数据域下的业务过程和维度。

### 规范定义

- 规范定义主要定义指标体系，包括原子指标、修饰词、时间周期和派生指标。

### 模型设计

- 模型设计主要包括维度及属性的规范定义，维表、明细事实表和汇总事实表的模型设计。相关实践详解请参考后续章节。

### 架构总结

- One Data的实施过程是一个高度迭代和动态的过程，一般采用螺旋式实施方法。
- 在总体架构设计完成之后，开始根据数据域进行迭代式模型设计和评审。
- 在架构设计、规范定义和模型设计等模型实施过程中，都会引入评审机制，以确保模型实施过程的正确性。

## 指标体系搭建

### 指标体系核心结构

![指标体系架构](\图片\指标体系架构.png)

- 具体模块说明：
  1. 数据域：是指一个或多个业务过程或者维度的集合。
  2. 原子指标：基于某一业务过程下的度量。例如：搜索+次数=访问次数PV
  3. 派生指标=时间修饰+其他修饰词+原子指标；属性是用来刻画某个实体对象维度的数据形态；事实叫做度量，如访问次数。
  4. 修饰：指针对原子指标的业务场景限定抽象。例如：最近N天。

### 指标体系中的数据规范

![原子指标数据规范](\图片\原子指标数据规范.png)

![原子指标数据规范解释1](\图片\原子指标数据规范解释1.png)

![原子指标数据规范2](\图片\原子指标数据规范2.png)

### 指标体系的基本原则

#### 组成体系之间的关系

1. 原子指标、修饰类型及修饰词，直接归属在业务过程下，其中修饰词继承修饰类型的数据域。
2. 派生指标由原子指标、时间周期修饰词、若干其他修饰词组合得到。派生指标可以选择多个修饰词，修饰词之间的关系为‘或’或者‘且’的关系，具体由具体的派生指标语义决定。
3. 派生指标唯一归属一个原子指标，继承原子指标的数据域、与修饰词的数据域无关。一般而言：事务型指标和存量型指标只会唯一定位到一个业务过程，如果遇到同时有两个行为发生、需要多个修饰、生成一个派生指标的话，选择时间靠后的行为创建原子指标，另一个时间靠前的行为创建为修饰词。
4. 原子指标有确定的英文字段名、数据类型和算法说明；派生指标要继承原子指标的英文名、数据类型和算法要求。

#### 命名约定

- 命名所用术语：尽量使用英文简写，其次是英文，当指标英文名太长时，可考虑用汉语拼音首字母命名。

1. 业务过程：英文名——用英文的缩写或者英文或者中文拼音简写；中文名——具体的业务过程中文即可。
2. 原子指标：英文名：动作+度量；中文名：动作+度量；
3. 修饰词：只有时间周期才会有英文名，且长度为2位，加上“_”为三位，例如_1d。其他修饰词无英文名。
4. 派生指标：
   - 英文名：原子指标英文名+时间周期修饰词（=3位，例如，_1d）+序号（=4位，例如，_001）。
   - 中文名：时间周期修饰词+[其他修饰词]+原子指标。

#### 操作细则

##### 派生指标的分类：

- 派生指标可以分为三类：事务型指标、存量型指标和复合型指标。
  - 事务型指标：是指对业务活动进行衡量的指标。
  - 存量型指标：是指对实体对象(如商品、会员)，某些状态的统计。
  - 复合型指标：是在事务性指标和存量型指标基础上复合而成的

### 维度属性的基本规则

1. 命名约定：维度和维度属性，尽量使用英文简写，其次是英文，当指标英文名太长时，可考虑用汉语拼音首字母命名。如中国质造，用zgzc。
2. 维度的归属：维度必须归属于某个数据域。
3. 在创建维度时，必须清楚维度的主键是什么：如会员维度的主键是会员ID，商品维度的主键是商品ID。从源系统引入的属性，如果没有重复，则尽量遵从源系统命名，如果有重复则与业务方沟通选择合理的命名以方便业务使用。
4. 维度属性：在维度下创建维度属性分为两类，一是直接从源系统引入，二是在源系统基础上、根据应用需求的数据挖掘出的属性特征作为维度的属性。
5. 关于行为维度和杂项维度：
   - 杂项维度一般指将事实表中的指示符、状态、分类、属性、标签等字段单独创建维表。比如交易订单、物流订单均可以称为杂项维度。
   - 行为维度是基于历史事实构建的维度，如会员最后一次登录时间，最后一次浏览的网页，这个可作为会员的维度属性，不建议单独创建维度。

6. 维度的拆解
   1.  如果维度不由事实决定两者的关系，如商品属于某个类目，建议通过父子关系拆解成两个维度。
   2. 如果两个维度是由事实的发生才建立关系，则必须拆解成多个维度，如交易表中的商品和买家。
   3. 杂项维度需新建一个维度，行为维度建议放在主体对象维度中。
   4. 角色维度如会员在交易中即扮演买家的角色又扮演卖家的角色，这两种角色的会有较多不一样的维度属性，如果会员这个维度会在多个事实中存在买家和卖家的角色，则可创建买家和卖家维度，并作为会员维度的子维度。
7. 维度属性的层级关系：商品归属于类目，所以商品的父维度是类目，类目的子维度是商品。
8. 多值维度：如果是行为累计的串类维度，如车辆运行轨迹中的GPS点列表，需要对轨迹做详细分析时建议在用户到达杂项维度创建GPS轨迹列表维度属性。如果是由于维度在事实中扮演的多个角色造成的多值维度建议按照第三点中的角色维度处理。

## 模型设计

### 数据分层

1. 数仓为什么要分层？
   1. 用空间换时间，通过大量的预处理来提升应用系统的用户体验（效率），因此数据仓库会存在大量冗余的数据；不分层的话，如果源业务系统的业务规则发生变化将会影响整个数据清洗过程，工作量巨大。
   2. 通过数据分层管理可以简化数据清洗的过程，因为把原来一步的工作分到了多个步骤去完成，相当于把一个复杂的工作拆成了多个简单的工作，把一个大的黑盒变成了一个白盒，每一层的处理逻辑都相对简单和容易理解，这样我们比较容易保证每一个步骤的正确性，当数据发生错误的时候，往往我们只需要局部调整某个步骤即可。
2. 一个好的分层架构，有以下好处：
   1. 清晰数据结构：每一个数据分层都有对应的作用域，在使用数据的时候能更方便的定位和理解。
   2. 数据血缘追踪：提供给业务人员或下游系统的数据服务时都是目标数据，目标数据的数据来源一般都来自于多张表数据。若出现目标数据异常时，清晰的血缘关系可以快速定位问题所在。而且，血缘管理也是元数据管理重要的一部分。
   3. 减少重复开发：数据的逐层加工原则，下层包含了上层数据加工所需要的全量数据，这样的加工方式避免了每个数据开发人员都重新从源系统抽取数据进行加工。
   4. 数据关系条理化：源系统间存在复杂的数据关系，比如客户信息同时存在于核心系统、信贷系统、理财系统、资金系统，取数时该如何决策呢？数据仓库会对相同主题的数据进行统一建模，把复杂的数据关系梳理成条理清晰的数据模型，使用时就可避免上述问题了。
   5. 屏蔽原始数据的影响：数据的逐层加工原则，上层的数据都由下一层的数据加工获取，不允许跳级取数。而原始数据位于数仓的最底层，离应用层数据还有多层的数据加工，所以加工应用层数据的过程中就会把原始数据的变更消除掉，保持应用层的稳定性。
3. 业界对数仓分层的看法大同小异，大体上认为分为接入层、中间层和应用层三层

#### 接入层(`ods`)

- 数据引入层（ODS，Operational Data Store，又称数据基础层）：将原始数据几乎无处理地存放在数据仓库系统中，结构上与源系统基本保持一致，是数据仓库的数据准备区。

#### 通用维度层(`dim`)

- 维度层（DIM，Dimension）：以维度作为建模驱动，基于每个维度的业务含义，通过添加维度属性、关联维度等定义计算逻辑，完成属性定义的过程并建立一致的数据分析维表。

#### 明细层(`dwd`)

- 明细数据层（DWD，Data Warehouse Detail）：以业务过程作为建模驱动，基于每个具体的业务过程特点，构建最细粒度的明细事实表。可以结合企业的数据使用特点，将明细事实表的某些重要属性字段做适当冗余，也即宽表化处理。
- 理论上明细层数据是对ods层数据进行清洗加工，提高ods层数据的可用性，对于dwd层数据是否同层引用的观点需要权衡：
- 一般情况下dwd层不建议同层引用，这样做可以减少明细层任务之间的依赖，减少节点深度。但是在某些场景下，ods层到dwd层数据加工逻辑复杂，计算开销大，这时可以权衡考虑适当复用dwd表来构建新的dwd表。

#### 汇总层(dws)

- 汇总数据层（DWS，Data Warehouse Summary）：以分析的主题对象作为建模驱动，基于上层的应用和产品的指标需求，构建公共粒度的汇总指标表。
- 以宽表化手段物理化模型，构建命名规范、口径一致的统计指标，为上层提供公共指标，建立汇总宽表、明细事实表。

- 这一层依赖我们的指标体系，将dwd层的数据按照各个维度进行聚合计算。当我们有一些跨业务域的聚合统计需求时，放到这一层。

#### 应用层(app)

- 数据应用层（ADS，Application Data Store）：存放数据产品个性化的统计指标数据，根据CDM层与ODS层加工生成。
- 这一层主要针对汇总层，进行相关指标的组合，生成报表。在这里，主要是提供给数据产品和数据分析使用的数据，一般会存放在ES、PostgreSql、Redis 等系统中供线上系统使用，也可能会存在 Hive 或者 Druid、Doris中供数据分析和数据挖掘使用。比如我们经常说的报表数据，一般就放在这里。

## 维度设计

- 维度建模中，将度量称为事实，维度用于分析事实所需要的多样环境。维度的作用一般是查询、分类汇总以及排序。
- 通过报表的约束条件，以及之前数据调研和业务方的沟通，我们可以获得维度。维度通过主键与事实表进行关联，维度表的主键分为代理键和自然键两种；代理键不具有业务含义，一般用于处理缓慢变化维度，自然键则具有业务含义。

### 维度设计基本方法

1. 选择或者新建一个维度，通过之前总线矩阵的构建掌握了目前数仓架构中的维度。
2. 确定主维表。此处主维表一般是ODS表，直接与业务系统同步。
3. 确定相关维表。数仓是业务源系统的数据整合，不同业务系统或者同一业务系统中的表之间存在关联性。根据对业务的梳理，我们可以确认哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。
4. 确定维度属性。本步骤分为两阶段，第一阶段是从主维表中选择维度属性或生成新的维度属性；第二阶段是从相关维表中选择维度属性或生成新的维度属性。

### 规范化和反规范化

- 当具有多层次的维度属性，按照第三范式进行规范化后形成一系列维度表，而非单一维度表，这种建模称为雪花模式。
- 将维度的属性层次合并到单个维度中的操作称为反规范化。

### 一致性维度和交叉探查

- 我们存在很多需求是对于不同数据域的业务过程或同一数据域的不同业务过程合并在一起观察。例如：对于日志数据域统计商品维度的近一天PV和UV；对于交易数据域统计商品维度近一天的GMV。
- 这种将不同数据域的商品事实合并在一起进行数据探查，称为交叉探查。
- 数仓能进行交叉探查的前提是，不同数据域要具有一致性维度。

### 维度整合

- 由于数仓的数据源来源于不同的应用系统，应用系统之间相互独立，因此对同一信息的描述、存储都可能具有差异。而这些具有差异的数据进入数仓后需要整合在一起：
  1. 命名规范的统一。表名、字段名等统一。
  2. 字段类型的统一。相同和相似字段的字段类型统一。
  3. 公共代码以及代码值的统一。
  4. 业务含义相同的表的统一。主要依据高内聚、低耦合的理念，将业务关系大，源系统影响差异小的表进行整合。
- 表级别的整合主要有两种形式：
  1. 垂直整合，即不同来源表包含相同的数据集，只是存储的信息不同，可以整合到同一个维度模型中。
  2. 水平整合，即不同来源表包含不同的数据集，这些子集之间无交叉或存在部分交叉，如果有交叉则去重；如果无交叉，考虑不同子集的自然键是否冲突，不冲突则可以将各子集自然键作为整合后的自然键，或者将各自然键加工成一个超自然键。

## 事实表设计

- 事实表中一条记录所表达的业务细节程度称为粒度。

### 事实类型

- 作为度量业务过程的事实，有可加性、半可加性和不可加性三种类型：
  - 可加性事实指可以按照与事实表关联的任意维度进行汇总。
  - 半可加事实只能按照特定维度汇总，不能对所有维度汇总。
  - 不可加性事实完全不具备可加性，比如比例事实。对于不可加性事实可考虑分解为可加的组件来实现聚合。

### 事实表类型

- 最常见的事实表有三种类型：事务事实表、周期快照事实表和累积快照事实表。
- 事务事实表用来描述业务过程，表示对应时空上某点的度量事件，保存的是最原子的数据，也称为原子事实表。在实际使用中，一般作为明细层使用，例如下单明细、支付明细等。
- 周期快照事实表的一行，以具有规律性的时间间隔记录事实。如每日库存快照表、每日用户余额快照表。
- 累积快照事实表用来表述过程开始和结束之间的关键步骤事件，覆盖过程的整个生命周期，通常具有多个日期字段来记录关键时间点，当过程随着生命周期不断变化时，记录也会随着过程的变化而被修改。以事务事实表中提到的订单例子为例，可以做一个和订单相关的，涉及订单下单、推单、抢单、支付等各个环节的一张订单全生命周期快照表。
- 此外，还有一种无事实的事实表，单纯只记录某一动作发生，其事件的量化是非数字的，比较典型的例子是访问点击日志。

### 事实表设计原则

- 尽可能包含所有与业务过程相关的事实。
- 只选择与业务过程相关的事实。
- 分解不可加性事实为可加的组件。
- 在选择维度和事实之前必须先声明粒度。
- 在同一个事实表中不能有多种不同粒度的事实。
- 事实的单位要保持一致。
- 对事实的null值要处理，建议用0填充。
- 使用退化维度提高事实表的易用性。

### 事实表设计方法

- 主要步骤包括：选择业务过程及确认事实表类型；声明粒度；确定维度；确定事实；冗余维度。
- 第一步:选择业务过程及确定事实表类型。
  - 在明确了业务需求以后，接下来需要进行详细的需求分析，对业务的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关的业务过程。
- 第二步:声明粒度。、
  - 粒度的声明是事实表建模非常重要的一步,意味着精确定义事实表的每一行所表示的业务含义,粒度传递的是与事实表度量有关的细节层次。明确的粒度能确保对事实表中行的意思的理解不会产生混淆，保证所有的事实按照同样的细节层次记录。
- 第三步:确定维度。
  - 完成粒度声明以后，也就意味着确定了主键，对应的维度组合以及相关的维度字段就可以确定了，应该选择能够描述清楚业务过程所处的环境的维度信息。
- 第四步:确定事实。
  - 事实可以通过回答“过程的度量是什么”来确定。应该选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致。事实有可加性、半可加性、非可加性三种类型，需要将不可加性事实分解为可加的组件。
- 第五步:冗余维度。
  - 在传统的维度建模的星形模型中,对维度的处理是需要单独存放在专门的维表中的，通过事实表的外键获取维度。这样做的目的是为了减少事实表的维度冗余，从而减少存储消耗。

## 开发规范

### 层次调用约定

- 应用层优先调用公共层数据。
- 已经存在的中间层数据，不允许应用层跨中间层从ODS层重复加工数据。
- 中间层团队应该积极了解应用层数据的建设需求，将公用的数据沉淀到公共层，为其他团队提供数据服务。
- 应用层团队也需要积极配合中间层团队进行数据公共层建设的改造和迁移。
- 必须避免过度使用ODS层引用和不合理的数据复制和子集合冗余。

### 命名规范

- 表命名规范：<层次><业务域名称><数据域名称><业务过程名称|自定义表名><刷新周期+存储策略>

### 字段命名规范

- ![字段命名规范](\图片\字段命名规范.png)

### 开发规范总原则

- 原则上不能依赖非数据团队节点。

- 未获得节点owner许可的情况下，不能擅自修改别人的节点。

- 不能随意变更节点owner，必须知会接收人并得到同意。

## 数据模型设计原则

### 高内聚、低耦合

- 即主题内部高内聚、不同主题间低耦合。明细层按照业务过程划分主题，汇总层按照“实体+活动”划分不同分析主题，应用层根据应用需求划分不同应用主题。

### 核心模型和扩展模型要分离

- 建立核心模型与扩展模型体系，核心模型包括的字段支持常用的核心业务，扩展模型包括的字段支持个性化或少量应用的需要，不能让扩展模型的字段过度侵入核心模型，以免破坏核心模型的架构简洁性与可维护性。

### 公共处理逻辑下沉及单一

- 越是底层公用的处理逻辑越应该在数据调度依赖的底层进行封装与实现，不要让公用的处理逻辑暴露给应用实现，不要让公共逻辑多处同时存在。

### 成本与性能平衡

- 适当的数据冗余可换取查询和刷新性能，不宜过度冗余与数据复制。

### 数据可回滚

- 处理逻辑不变，在不同时间多次运行数据结果确定不变。

### 一致性

- 具有相同含义的字段在不同表中的命名必须相同，必须使用规范定义中的名称。

### 命名清晰、可理解

- 表命名需清晰、一致，表名需易于消费者理解和使用。

## 数仓开发规范

### 层次调用规范

- 在完成数据仓库的分层后，您需要对各层次的数据之间的调用关系作出约定。
- 总体遵循的层次调用原则如下：
  1. ODS层数据不能直接被应用层任务引用。如果中间层没有沉淀的ODS层数据，则通过CDM层的视图访问。CDM层视图必须使用调度程序进行封装，保持视图的可维护性与可管理性。
  2. CDM层任务的深度不宜过大（建议不超过10层）。
  3. 一个计算刷新任务只允许一个输出表，特殊情况除外。
  4. CDM汇总层优先调用CDM明细层，可累加指标计算。CDM汇总层尽量优先调用已经产出的粗粒度汇总层，避免大量汇总层数据直接从海量的明细数据层中计算得出。
  5. CDM明细层累计快照事实表优先调用CDM事务型事实表，保持数据的一致性产出。
  6. 有针对性地建设CDM公共汇总层，避免应用层过度引用和依赖CDM层明细数据。

### 数据类型规范

- 需统一规定不同的数据的数据类型，严格按照规定的数据类型执行：

- 金额：double 或 使用 decimal(28,6) 控制精度等，明确单位是分还是元。

- 字符串：string。

- id类：bigint。

- 时间：string。

- 状态：string。

### 数据冗余规范

- 宽表的冗余字段要确保：
  1. 冗余字段要使用高频，下游3个或以上使用。
  2. 冗余字段引入不应造成本身数据产生过多的延后。
  3. 冗余字段和已有字段的重复率不应过大，原则上不应超过60%，如需要可以选择join或原表拓展。

### 空值处理规范

1. 对于维度字段，需设置为-1
2. 对于指标字段，需设置为0

### 指标口径规范

- 保证主题域内，指标口径一致，无歧义。通过数据分层，提供统一的数据出口，统一对外输出的数据口径，避免同一指标不同口径的情况发生。

1. 指标梳理
   - 指标口径的不一致使得数据使用的成本极高，经常出现口径打架、反复核对数据的问题。
   - 在数据治理中，我们将需求梳理到的所有指标进行进一步梳理，明确其口径，如果存在两个指标名称相同，但口径不一致，先判断是否是进行合并，如需要同时存在，那么在命名上必须能够区分开。
2. 指标管理

- 指标管理分为原子指标维护和派生指标维护。

- 原子指标
  - 选择原子指标的归属产线、业务板块、数据域、业务过程
  - 选择原子指标的统计数据来源于该业务过程下的原始数据源
  - 录入原子指标的英文名称、中文名称、概述
  - 填写指标函数
  - 系统根据指标函数自动生成原子指标的定义表达式
  - 系统根据指标定义表达式以及数据源表生成原子指标SQL
- 派生指标
  - 在原子指标的基础之上选择了一些维度或者修饰限定词。

## 数据表处理规范

1. 增量表
   - 新增数据，增量数据是上次导出之后的新数据。
   - 记录每次增加的量，而不是总量；
   - 增量表，只报变化量，无变化不用报；
   - 每天一个分区。

2) 全量表
   - 每天的所有的最新状态的数据。
   - 全量表，有无变化，都要报；
   - 每次上报的数据都是所有的数据（变化的 + 没有变化的）；
   - 只有一个分区。

3. 快照表
   - 按日分区，记录截止数据日期的全量数据。
   - 快照表，有无变化，都要报；
   - 每次上报的数据都是所有的数据（变化的 + 没有变化的）；
   - 一天一个分区。

4. 拉链表
   - 记录截止数据日期的全量数据。
   - 记录一个事物从开始，一直到当前状态的所有变化的信息；
   - 拉链表每次上报的都是历史记录的最终状态，是记录在当前时刻的历史总 量；
   - 当前记录存的是当前时间之前的所有历史记录的最后变化量（总量）；
   - 只有一个分区。
