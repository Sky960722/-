# 数据模型架构规范

- 参考文档：https://bbs.fanruan.com/thread-137547-1-1.html

## 1. 整体命名规范
1. 周期/数据范围：
2. 日快照：d
3. 增量：i
4. 全量：f
5. 周：w
6. 拉链表：l
7. 非分区全量表：a

## 2.数仓分层体系

- 目标：一个好的分层架构，要有以下好处：
  1. 清晰数据结构；
  2. 数据血缘追踪；
  3. 减少重复开发；
  4. 数据关系条理化；
  5. 屏蔽原始数据的影响。

### CDM层

- 作用：CDM集群是华为云产品，基于sqoop组件从业务层拉取数据到`ODS`层的`ODM`层
- `Job`命名规则
  - `[F/I]_schemaName_tblName`
    - `F`：表示全量拉取数据
    - `I`：表示增量拉取数据
    - `schemaName`：表示拉取的上游库。所有的上游库名转化为对应的系统代号（系统代号由数仓维护）。
    - `tblName`：表示拉取的上游表名

### ODS层

- 作用：

- 数据源层：`ODS`（`Operational Data Store`）
  - `ODS`层又细分为 `ODM`层、`SDM`层 两层。

#### ODM层

- `ODM` 层通常是指 "`Operational Data Store`" 层，中文称为 "操作数据存储层"。
  - 作用：这是一个位于数据仓库架构中的关键层级，用于存储从源系统抽取的原始数据。

#### SDM层

- `SDM`层 通常指的是 "`Staging Data Mart`" 层，中文称为 "暂存数据集市层"。
- `SDM` 层是数据仓库中的一个关键组成部分，目前主要功能是以日为分区永久存储`ODM`层每天跑批的数据。

### DW层

- 作用：从 `ODS` 层中获得的数据按照主题建立各种数据模型。未来所有的数据都会从`ODS`层的`SDM`层加工获取。
- **`DW`** 层又细分为 **`DWD`**（`Data Warehouse Detail`）层、**`DWM`**（`Data WareHouse Middle`）层和 **`DWS`**（`Data WareHouse Servce`） 层。

#### DWD层

- 数据明细层：DWD（Data Warehouse Detail）
- 该层一般保持和 ODS 层一样的数据粒度，并且提供一定的数据质量保证。**DWD 层要做的就是将数据清理、整合、规范化、脏数据、垃圾数据、规范不一致的、状态定义不一致的、命名不规范的数据都会被处理**。

#### DWM层

- 数据中间层：`DWM`（`Data WareHouse Middle`）
- 该层会在 `DWD` 层的数据基础上，数据做轻度的聚合操作，生成一系列的中间表，提升公共指标的复用性，减少重复加工。
- 直观来讲，**就是对通用的核心维度进行聚合操作，算出相应的统计指标**。
- 目前可以不加，直接将数据从`DWD`层加工到`DWS`层

#### DWS层

- 数据服务层：`DWS`（`Data WareHouse Servce`）
- DWS 层为公共汇总层，会进行轻度汇总，粒度比明细数据稍粗，基于 DWD 层上的基础数据，**整合汇总成分析某一个主题域的服务数据，一般是宽表**。`DWS` 层应覆盖 80% 的应用场景。又称数据集市或宽表。


### ADS层

- `ADS`层叫应用服务层，一般就直接对接`OLAP`分析，或者业务层数据调用接口了。

- 命名规则待定

### DIM层

- "`DIM` 层" 通常指的是 "`Dimensional Data Store`" 层，中文称为 "维度数据存储层"。

- 如果维表过多，也可针对维表设计单独一层，维表层主要包含两部分数据：

  - **高基数维度数据**：一般是用户资料表、商品资料表类似的资料表。数据量可能是千万级或者上亿级别。

  - **低基数维度数据**：一般是配置表，比如枚举值对应的中文含义，或者日期维表。数据量可能是个位数或者几千几万。

## 3.数据模型设计原则

### 1.高内聚、低耦合

- 即**主题内部高内聚、 不同主题间低耦合**。主题与主题之间的数据计算要分开，不要相互主题之间互相引用字段逻辑。对于几个以上的主题都用到的字段，可以考虑重新抽象出一个主题表，其余主题字段都引用该字段。

### 2. 核心模型和扩展模型要分离

- 建立核心模型与扩展模型体系，核心模型包括的字段支持常用的核心业务，扩展模型包括的字段支持个性化或少量应用的需要，**不能让扩展模型的字段过度侵入核心模型，以免破坏核心模型的架构简洁性与可维护性**。

### 3. 公共处理逻辑下沉及单一

- 越是底层公用的处理逻辑越应该在数据调度依赖的底层进行封装与实现，**不要让公用的处理逻辑暴露给应用实现，不要让公共逻辑多处同时存在**。

### 4.成本与性能平衡

- 适当的数据冗余可换取查询和刷新性能，不宜过度冗余与数据复制。

### 5.数据可回滚

- 处理逻辑不变，在不同时间多次运行数据结果确定不变。

## 4.数仓公共开发规范

### 1. 层次调用规范

1. 所有数据均从`dwd`层出发,开发阶段可以遵守 `dwd` -> `app`层。

2. 在保障了数据链路的合理性之后，也必须保证模型分层引用原则：

   - 正常流向：`ODS -> DWD -> DWM -> DWS -> APP`，当出现 `ODS -> DWD -> DWS -> APP` 这种关系时，说明主题域未覆盖全。应将 `DWD` 数据落到 `DWM` 中，对于使用频度非常低的表允许 `DWD -> DWS`。

   - 尽量避免出现 `DWS` 宽表中使用 `DWD` 又使用（该 `DWD` 所归属主题域）`DWM` 的表。

   - 同一主题域内对于 `DWM` 生成 `DWM` 的表，原则上要尽量避免，否则会影响 `ETL` 的效率。

   - `DWM`、`DWS` 和 `APP` 中禁止直接使用 `ODS` 的表， `ODS` 的表只能被 `DWD` 引用。

   - **禁止出现反向依赖**，例如 `DWM` 的表依赖 `DWS` 的表。

### 2.数据类型规范

- 需统一规定不同的数据的数据类型，严格按照规定的数据类型执行：
  1. 金额：使用 `decimal(28,6)` 控制精度等，明确单位是分还是元。
  2. 字符串：`varchar`或者`String`。除非经过加工，否则应该和上层表的字段属性相同。
  3. 时间：`10`位有效日期，类型`date`
  4. 时间戳： hive的时间戳类型`yyyy-MM-dd hh:mm:ss`。使用时需要注意。

### 3.数据冗余规范

- 宽表的冗余字段要确保：

  1. 冗余字段要使用高频，**下游3个或以上使用**。

  2. 冗余字段引入**不应造成本身数据产生过多的延后**。

  3. 冗余字段**和已有字段的重复率不应过大，原则上不应超过60%**，如需要可以选择join或原表拓展。

### 4.指标口径规范

- **保证主题域内，指标口径一致，无歧义**。
- 通过数据分层，提供统一的数据出口，统一对外输出的数据口径，避免同一指标不同口径的情况发生。

## 5.数据表处理规范

### 增量表

- 新增数据，增量数据是上次导出之后的新数据。

  1. 记录每次增加的量，而不是总量；

  2. 增量表，只报变化量，无变化不用报；

  3. 每天一个分区。

### 全量表

- 每天的所有的最新状态的数据。

  1. 全量表，有无变化，都要报；

  2. 每次上报的数据都是所有的数据（变化的 + 没有变化的）；

  3. 只有一个分区。

### 快照表

- 按日分区，记录截止数据日期的全量数据。

  1. 快照表，有无变化，都要报；

  2. 每次上报的数据都是所有的数据（变化的 + 没有变化的）；

  3. 一天一个分区。

### 拉链表

- 记录截止数据日期的全量数据。

  1. 记录一个事物从开始，一直到当前状态的所有变化的信息；

  2. 拉链表每次上报的都是历史记录的最终状态，是记录在当前时刻的历史总 量；

  3. 当前记录存的是当前时间之前的所有历史记录的最后变化量（总量）；

  4. 只有一个分区。

## 6.表的生命周期管理

- `SDM`层数据生命周期永久，部分`DWS`层数据需要查看历史轨迹变化，因此需要做拉链。其余层都只保留一星期数据。

## 7.数仓命名规范





