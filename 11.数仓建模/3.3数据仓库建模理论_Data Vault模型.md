# Data Vault模型

## 概念

- Data Vault是一种数据仓库建模方法，用来存储来自多个操作型系统的完整的历史数据。Data Vault方法需要跟踪所有数据的来源，因此其中每个数据行都要包含数据来源和装载时间属性，用以审计和跟踪数据值所对应的源系统。
- Data Vault是面向细节的、可追踪历史的、一组有连接关系的规范化的表的集合。这些表可以支持一个或多个业务功能，它是一种综合了第三范式(3NF)和星型模型优点的建模方法。

## Data Vault模型组成部分

- Data Vault模型是一种中心辐射式模型，其设计重点围绕着业务键的集成模式。

- 这些业务键是存储在多个系统中的、针对各种信息的键，用于定位和唯一标识记录或数据。

- Data Vault模型有中心表(Hub)、链接表(Link)、附属表(Satellite)三个主要组成部分，中心表记录业务主键，链接表记录业务关系，附属表记录业务描述。

- 下面来看一个实际的例子：如下图，hub—中心表、link—链接表、sat—卫星表。

  ![DataValue模型](\图片\DataValue模型.png)

### 中心表（Hub组件）

- 中心表用来保存一个组织内的每个实体的业务主键，业务主键唯一标识某个业务实体。中心表和源系统表是相互独立的。当一个业务主键被用在多个系统时，它在Data Vault中也只保留一份，其他的组件都能接到这一个业务主键上。
- ![中心表](\图片\中心表.png)

- 表内包括几个关键字段：代理主键（Surrorgate Key），即hub表的主键；业务实体主键（Business Key）,记录业务键值；装载时间（Load Data/Time Stamp），记录该业务键值的记录时间；数据源（Record Source）,记录该业务键值的来源，以追踪数据。

### 链接表（Link组件）

- 链接表是不同中心表之间的关系链接，链接表一般由一组外键字段构成，通过存储相关业务实体间Hub表的代理主键(Surrorgate Key)，以记录一对多、多对多的业务实体间关系，如员工与企业的雇佣关系，账户与客户之间的关系等。
- ![链接表](\图片\链接表.png)

### 附属表（Satellite组件）

- 附属表用于保存中心表和链接表的描述属性，包含了所有历史变化数据，附属表有且仅有一个唯一外键关联到中心表或链接表。
- Hub表中业务主键所对应的业务描述，即业务实体的属性信息，这些信息具有时效性，随时间变化而可能产生变化，因此，Satellite组件内的记录均具有时间维，可记录实体属性的历史变化情况。
- 根据实体属性变化频率的不同，可将一类实体的业务属性分为若干Satellite表，通过向Satellite分表追加记录，以实现在更小粒度下，实现第二类渐变维的保存历史数据特性。
- Satellite组件包括以下关键字段：代理主键（Surrorgate Key），即Satellite组件表的主键；Hub或Link表的主键，Satellite联合主键之一，记录该Satellite组件所属Hub或Link；装载时间（Load Data/Time Stamp），Satellite联合主键之一，记录该描述信息在数仓中的有效时间；数据源（Record Source）,记录该描述信息的来源，以追踪数据。
- ![附属表](\图片\附属表.png)

## Data Vault模型的特点

- 一个设计良好的Data Vault模型应该具有以下特点:
  1. 所有数据都基于时间来存储，即使数据是低质量的，也不能在ETL过程中处理掉。依赖越少越好。
  2. 和源系统越独立越好。
  3. 设计上适合变化：源系统中数据的变化；在不改变模型的情况下可扩展。
  4. ETL作业可以重复执行。
  5. 数据完全可追踪。

## Data Vault模型的构建

- 在Data Vault模型中，各个实体有着严格、通用的定义与准确、灵活的功能描述，这不但使得Data Vault模型能够最直观、最一般地反映数据之间内含的业务规则，同时也为构建Data Vault模型提供了一致而普遍的方法。
- Data Vault模型的建立可以遵循如下步骤:

### 设计中心表

1. 确定企业数据仓库要涵盖的业务范围。
2. 按业务范围划分若干原子业务实体，比如：客户、产品、投资品种等。
3. 从各个业务实体中抽象出能够唯一标识该实体的业务主键，该业务主键要在整个业务的生命周期内不会发生变化。
4. 按照业务主键生成中心表。

### 设计链接表

- 链接表体现了中心表之间的业务关联。设计链接表，首先要熟悉各个中心表代表的业务实体之间的业务关系，可能是两个或者多个中心表之间的关系。根据业务需求，这种关系可以是1对1、1对多、多对多的。
- 然后，从相互之间有业务关系的中心表中，提取出代表各自业务实体的中心表主键。这些主键将被加入到链接表中，组合构成该链接表的主键。同样出于技术的原因，需要增加代理键。

### 设计附属表

- 附属表包含了各个业务实体与业务关联的详细的上下文描述信息。设计附属表，首先要收集各个业务实体在提取业务主键后的其他信息，比如客户住址、产品价格等。
- 由于同一业务实体的各个描述信息不具有稳定性，会经常发生变化，所以在必要的时候，需要将变化频率不同的信息分隔开来，为一个中心表建立几个附属表，然后提取出该中心表的主键，作为描述该中心表的附属表的主键。

### 设计必要的PIT表

- Poit-In-Time表是由附属表派生而来的。如果一个中心表或者链接表设计有多个附属表的话，而为了访问数据方便，就有用到PIT表的可能。
- Point-In-Time辅助表，用于同一Hub的多个Satellite组件间的时间同步。因为同一业务实体的不同类型属性的更新频率不同，因此同一Hub的多个Satellite组件基本不会同步更新，因此，只需要在PIT表中记录在同一时点同时有效的Satellite组件描述信息即可，以保证查询到的数据是查询时点的实体状态。通过PIT表中的记录，可以清晰的分析业务实体属性的变化频率及频率差异。
- PIT表用于解决多Satellite组件统一时点的问题，如果只有一个Satellite组件则不需要PIT表。PIT表的主键也是由其所归属的中心表提取而来，该中心表有几个附属表，PIT表就至少应该有几个字段来存放各个附属表的变化对比时间。
